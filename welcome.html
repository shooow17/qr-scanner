<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>班級即時顯示</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <style>
        body { font-family: Arial, sans-serif; background-color: #f0f8ff; display: flex; justify-content: center; align-items: center; flex-direction: column; height: 100vh; margin: 0; color: #333; }
        .container { text-align: center; background-color: #ffffff; padding: 40px 60px; border-radius: 12px; box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1); }
        h1 { font-size: 2.5em; margin: 0; color: #005a9c; }
        p { font-size: 1.4em; margin-top: 10px; color: #555; }
        
        #status-buttons {
            margin-top: 25px;
            display: none; /* 預設隱藏 */
        }
        #status-buttons button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 20px;
            margin: 5px;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
        }
        #status-buttons button:hover {
            background-color: #0056b3;
        }
        
        #btn-clear {
            background-color: #6c757d; 
        }
        #btn-clear:hover {
            background-color: #5a6268;
        }
        #btn-clear.sent,
        #status-buttons button.sent {
            background-color: #28a745; 
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="welcome-message">等待掃描中...</h1>
        <p id="student-id">請在掃描裝置上開始掃描</p>
        
        <div id="status-buttons">
            <button onclick="sendToGuard('收拾書包前往警衛室')">收拾書包前往警衛室</button>
            <button onclick="sendToGuard('上廁所請稍候')">上廁所請稍候</button>
            <button onclick="sendToGuard('班級在室外活動')">班級在室外活動</button>
            <button id="btn-clear" onclick="processNextStudent()">處理完畢 (下一位)</button>
        </div>
    </div>

    <script>
        // --- 2. 你的 Firebase 設定 (我已幫你貼上) ---
        const firebaseConfig = {
          apiKey: "AIzaSyB_-fHCMhi-URwyBqzAIipmffWwvNgzJJc",
          authDomain: "qr-scanner-app-2c73d.firebaseapp.com",
          databaseURL: "https://qr-scanner-app-2c73d-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "qr-scanner-app-2c73d",
          storageBucket: "qr-scanner-app-2c73d.firebasestorage.app",
          messagingSenderId: "385628927398",
          appId: "1:385628927398:web:00239f1b2acebd6e790b67"
        };
        // ------------------------------------

        // --- 3. 初始化 Firebase ---
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        // ------------------------
        
        const GUARD_ALERTS_KEY = "alerts"; // 警衛室的 Key
        let classQueueRef = null; 
        
        let currentStudentData = null; 
        let studentQueue = []; // 本地佇列
        let currentClassName = ""; // 儲存班級名稱

        function updateDisplay() {
            const messageElement = document.getElementById('welcome-message');
            const idElement = document.getElementById('student-id');
            const buttonsElement = document.getElementById('status-buttons');

            if (studentQueue.length > 0) {
                // 顯示佇列中的第一位學生
                currentStudentData = studentQueue[0];
                
                messageElement.textContent = `${currentStudentData.name}同學 (${currentStudentData.class})`;
                idElement.textContent = `家長來接囉`;

                buttonsElement.style.display = 'block'; 
                
                document.querySelectorAll('#status-buttons button').forEach(btn => {
                    btn.classList.remove('sent');
                    btn.disabled = false;
                });

            } else {
                // 佇列是空的
                currentStudentData = null;
                messageElement.textContent = `班級 ${currentClassName} - 等待掃描中...`;
                idElement.textContent = '請在掃描裝置上開始掃描';
                buttonsElement.style.display = 'none'; 
            }
        }
        
        async function sendToGuard(statusMessage) {
            if (!currentStudentData) return;

            console.log(`傳送訊息給警衛室: ${currentStudentData.name} (${currentStudentData.class}) - ${statusMessage}`);

            const guardData = {
                name: currentStudentData.name,
                class: currentStudentData.class, 
                status: statusMessage,
                timestamp: new Date().toISOString()
            };
            
            const clickedButton = event.target;
            clickedButton.classList.add('sent');
            clickedButton.disabled = true;

            try {
                const alertsRef = database.ref(GUARD_ALERTS_KEY);
                await alertsRef.push(guardData);
                console.log("訊息成功傳送到警衛室");
                
                // [修正] 傳送成功後，呼叫「處理下一位」
                processNextStudent(); 

            } catch (err) {
                console.error("傳送失敗:", err);
                alert(`傳送失敗: ${err.message}`);
                clickedButton.classList.remove('sent'); 
                clickedButton.disabled = false;
            }
        }

        // [修正] "處理完畢" 按鈕的函式
        function processNextStudent() {
            if (!currentStudentData) return;

            console.log(`處理完畢: ${currentStudentData.name}，正在移除佇列...`);
            
            // [關鍵修正] 
            // 為了防止 10 秒後連線失效導致 .remove() 失敗，
            // 我們「立即」從本地端移除，並更新畫面。
            // 這樣即使 .remove() (背景) 失敗，使用者介面也是正確的。
            
            const keyToRemove = currentStudentData.key;
            
            // 1. 立即從本地佇列移除
            studentQueue.shift(); 
            
            // 2. 立即更新畫面 (顯示下一位，或顯示「等待中」)
            updateDisplay();

            // 3. 在背景嘗試從 Firebase 刪除 (fire-and-forget)
            classQueueRef.child(keyToRemove).remove()
                .then(() => {
                    console.log(`成功從 Firebase 移除 Key: ${keyToRemove}`);
                })
                .catch(err => {
                    // 即使刪除失敗 (例如網路斷線)，本地也已經處理完畢
                    // 下次重新載入時，Firebase 的 on('child_added') 會重新同步
                    console.error(`從 Firebase 移除 Key: ${keyToRemove} 失敗:`, err);
                });
        }
        
        // [修改] 重新命名 "clearAndRestartPolling" -> "processNextStudent"
        // (因為我們不再 "polling"，而是用 "push")

        document.addEventListener('DOMContentLoaded', () => {
            
            const urlParams = new URLSearchParams(window.location.search);
            const className = urlParams.get('class');
            const messageElement = document.getElementById('welcome-message');

            if (!className) {
                messageElement.innerHTML = "<b>設定錯誤：</b><br>請在網址列指定班級<br>(例如: .../welcome.html<b>?class=ClassA</b>)";
                return;
            }
            
            if (firebaseConfig.apiKey === "YOUR_API_KEY") {
                messageElement.innerHTML = "<b>設定錯誤：</b><br>請先在 welcome.html 中貼入你的 firebaseConfig。";
                return;
            }
            
            classQueueRef = database.ref(`queues/${className}`);
            currentClassName = className; // 儲存班級名稱
            messageElement.textContent = `班級 ${className} - 載入中...`;

            // 監聽新加入的學生 (推播)
            classQueueRef.on('child_added', (snapshot) => {
                const studentData = snapshot.val();
                studentData.key = snapshot.key; 
                console.log("收到新學生:", studentData.name);
                studentQueue.push(studentData);
                // 只有當這是佇列中的第一位時，才更新畫面
                if (studentQueue.length === 1) {
                    updateDisplay();
                }
            });
            
            // 監聽被移除的學生 (推播)
            // (這個監聽器是為了同步，以防 "processNextStudent" 的本地移除失敗)
            classQueueRef.on('child_removed', (snapshot) => {
                console.log(`學生 ${snapshot.val().name} 已被遠端移除`);
                // 如果本地佇列的第一個 key 和被移除的 key 相同
                if (studentQueue.length > 0 && studentQueue[0].key === snapshot.key) {
                    studentQueue.shift(); // 移除本地
                    updateDisplay(); // 更新畫面
                }
            });

            // 第一次載入時，更新一次畫面
            updateDisplay();
        });
    </script>
</body>
</html>
