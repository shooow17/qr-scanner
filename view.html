<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>警衛室響應式顯示介面)</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <style>
        body { 
            font-family: Arial, sans-serif; 
            background-color: #fff8f0; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            flex-direction: column; 
            height: 100vh; 
            margin: 0; 
            color: #5d4037; 
        }
        .container { 
            text-align: center; 
            background-color: #ffffff; 
            padding: 40px; 
            border-radius: 12px; 
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1); 
            width: 90%; 
            max-width: 1200px; 
        }
        h1 { 
            font-size: 2.5em; 
            margin: 0; 
            color: #d84315; 
        }
        
        /* [修正] 網格 RWD */
        #alert-grid {
            margin-top: 20px;
            display: grid;
            /* 預設 5 欄 (桌機) */
            grid-template-columns: repeat(5, 1fr); 
            gap: 15px;
            width: 100%;
            height: 60vh; 
            overflow-y: auto; /* 保持內容可捲動 */
        }
        .alert-item {
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            text-align: left;
            background-color: #fafafa;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            line-height: 1.5; 
        }
        .placeholder {
            background-color: #fdfdfd;
            border: 1px dashed #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            color: #ccc;
        }
        
        .alert-message {
            font-size: 1.4em; 
            color: #333; 
            font-weight: bold; 
        }
        .alert-message .student-name {
            color: #005a9c; 
            display: block; 
            font-size: 1.3em; 
            margin-bottom: 8px;
        }
        .alert-message .status {
            color: #d84315; 
        }
        .alert-time {
            font-size: 1em; 
            color: #777;
            margin-top: 10px;
            display: block;
        }
        .controls {
            margin-top: 20px;
            width: 100%;
            display: flex;
            justify-content: space-between;
        }
        .controls button {
            background-color: #d84315;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
        }
         .controls button#btn-export {
            background-color: #00796b;
        }

        /* --- [新] RWD 媒體查詢 --- */
        
        /* 平板 (1024px 以下) */
        @media (max-width: 1024px) {
            .container {
                padding: 20px;
            }
            #alert-grid {
                grid-template-columns: repeat(3, 1fr); /* 3 欄 */
                height: 70vh;
            }
        }

        /* 手機 (600px 以下) */
        @media (max-width: 600px) {
            body { 
                height: auto; /* 允許手機滾動 */
                padding: 10px 0;
            }
            .container { 
                width: 95%;
                padding: 15px;
                height: auto;
            }
            h1 { font-size: 2em; }
            #alert-grid {
                grid-template-columns: 1fr; /* 1 欄 */
                height: auto;
                max-height: 50vh; /* 限制高度，但允許網格內部滾動 */
            }
            .alert-message { font-size: 1.2em; }
            .alert-message .student-name { font-size: 1.2em; }
            
            .controls {
                flex-direction: column; /* 讓按鈕垂直堆疊 */
                gap: 10px; /* 增加按鈕間距 */
            }
        }
        /* --- [RWD 結束] --- */

    </style>
</head>
<body>
    <div class="container">
        <h1>警衛室即時訊息</h1>
        <div id="alert-grid">
            </div>

        <div class="controls">
            <button id="btn-clear" onclick="clearAlerts()">清除畫面 (並清空資料庫)</button>
            <button id="btn-export" onclick="exportReport()">匯出報表 (CSV)</button>
        </div>
    </div>

    <script>
        // --- 2. 你的 Firebase 設定 (我已幫你貼上) ---
        const firebaseConfig = {
          apiKey: "AIzaSyB_-fHCMhi-URwyBqzAIipmffWwvNgzJJc",
          authDomain: "qr-scanner-app-2c73d.firebaseapp.com",
          databaseURL: "https://qr-scanner-app-2c73d-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "qr-scanner-app-2c73d",
          storageBucket: "qr-scanner-app-2c73d.firebasestorage.app",
          messagingSenderId: "385628927398",
          appId: "1:385628927398:web:00239f1b2acebd6e790b67"
        };
        // ------------------------------------

        // --- 3. 初始化 Firebase ---
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        // ------------------------

        const GUARD_ALERTS_KEY = "alerts"; 
        const QUEUES_KEY = "queues"; 
        const alertsRef = database.ref(GUARD_ALERTS_KEY);
        const queuesRef = database.ref(QUEUES_KEY); 
        
        const MAX_ALERTS = 15; // 15 格
        let alertHistory = []; 

        function renderGrid() {
            const gridElement = document.getElementById('alert-grid');
            gridElement.innerHTML = ''; 
            
            const itemsToDisplay = alertHistory.slice(-MAX_ALERTS).reverse();

            for (let i = 0; i < MAX_ALERTS; i++) {
                const item = itemsToDisplay[i];
                const cell = document.createElement('div');
                cell.className = 'alert-item';

                if (item) {
                    const localTime = new Date(item.timestamp).toLocaleString('zh-TW');
                    cell.innerHTML = `
                        <div class="alert-message">
                            <span class="student-name">${item.name} (${item.class})</span>
                            <span class="status">${item.status}</span>
                        </div>
                        <span class="alert-time">(時間: ${localTime})</span>
                    `;
                } else {
                    cell.classList.add('placeholder');
                    cell.textContent = '---'; 
                }
                gridElement.appendChild(cell);
            }
        }

        function clearAlerts() {
            if (!confirm("確定要清除所有警衛室和班級的資料嗎？(這會清空資料庫)")) {
                return;
            }
            console.log("正在清除所有警報和佇列...");
            
            alertsRef.remove().catch(err => alert(`清除 [alerts] 失敗: ${err.message}`));
            queuesRef.remove().catch(err => alert(`清除 [queues] 失敗: ${err.message}`));
        }
        
        function exportReport() {
            if (alertHistory.length === 0) {
                alert("目前沒有資料可匯出。");
                return;
            }

            console.log("正在產生報表...");
            
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
            csvContent += "時間,班級,學生姓名,狀態\r\n";

            [...alertHistory].reverse().forEach(item => {
                const time = new Date(item.timestamp).toLocaleString('zh-TW');
                const row = `"${time}","${item.class}","${item.name}","${item.status}"`;
                csvContent += row + "\r\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `警衛室報表_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link); 
            link.click();
            document.body.removeChild(link);
        }

        document.addEventListener('DOMContentLoaded', () => {
            
            alertsRef.limitToLast(MAX_ALERTS).on('child_added', (snapshot) => {
                const alertData = snapshot.val();
                alertData.key = snapshot.key; 
                console.log("收到新警報:", alertData.name);
                
                alertHistory.push(alertData); 
                if (alertHistory.length > MAX_ALERTS) {
                    alertHistory.shift(); 
                }
                renderGrid(); 
            });

            alertsRef.on('value', (snapshot) => {
                if (!snapshot.exists()) {
                    console.log("Firebase 資料庫 (alerts) 已清空");
                    alertHistory = [];
                    renderGrid(); 
                }
            });
            
            queuesRef.on('value', (snapshot) => {
                if (!snapshot.exists()) {
                    console.log("Firebase 資料庫 (queues) 已清空");
                }
            });

            renderGrid();
        });
    </script>
</body>
</html>
